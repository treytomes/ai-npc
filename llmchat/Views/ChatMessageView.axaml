<UserControl
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:llmchat.ViewModels"
    x:Class="llmchat.Views.ChatMessageView"
    x:DataType="vm:ChatMessageViewModel">

    <Border
        Classes.role-user="{Binding IsUser}"
        Classes.role-assistant="{Binding IsAssistant}"
        Classes.role-system="{Binding IsSystem}"
        Classes.role-tool="{Binding IsTool}"
		Classes.archived="{Binding IsArchived}"
        CornerRadius="6"
        BorderThickness="1"
        Padding="8"
        Margin="6">

        <DockPanel>

            <!-- Header -->
            <Grid DockPanel.Dock="Top" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
				<TextBlock
					Grid.Column="0"
					Text="{Binding RoleLabel}"
					FontWeight="Bold"
					VerticalAlignment="Center"/>

				<Border
					Grid.Column="1"
					IsVisible="{Binding IsArchived}"
					Background="#884444"
					CornerRadius="4"
					Padding="6,2"
					VerticalAlignment="Center">

					<TextBlock
						Text="ARCHIVED"
						FontSize="10"
						FontWeight="Bold"
						Foreground="White"/>
				</Border>

				<Button
					Grid.Column="2"
					Content="{Binding ExpandGlyph}"
					Command="{Binding ToggleExpandedCommand}"
					Width="28"
					Height="28"
					ToolTip.Tip="Expand / collapse message"/>
            </Grid>

            <!-- Collapsible Content -->
            <StackPanel
                Margin="0,6"
                IsVisible="{Binding IsExpanded}"
                Opacity="{Binding IsExpanded, Converter={StaticResource BoolToOpacityConverter}}">

                <StackPanel.Transitions>
                    <Transitions>
                        <DoubleTransition Property="Opacity"
                                          Duration="0:0:0.15"/>
                    </Transitions>
                </StackPanel.Transitions>

                <!-- Message -->
				
				<!-- Read mode -->
				<TextBlock
					IsVisible="{Binding !IsEditing}"
					Text="{Binding Content}"
					TextWrapping="Wrap"/>

				<!-- Edit mode -->
				<TextBox
					IsVisible="{Binding IsEditing}"
					Text="{Binding EditBuffer}"
					AcceptsReturn="True"
					TextWrapping="Wrap"
					MinHeight="80"/>


                <!-- Toolbar -->

				<!-- Normal toolbar -->
				<StackPanel
					IsVisible="{Binding !IsEditing}"
					Orientation="Horizontal"
					HorizontalAlignment="Right"
					Spacing="6"
					Margin="0,8,0,0">

					<Button Content="âœï¸" Width="28" Height="28" Padding="4" HorizontalContentAlignment="Center" HorizontalAlignment="Center" VerticalAlignment="Center" Command="{Binding EditCommand}" ToolTip.Tip="Edit"/>
					<Button Content="ðŸ“‹" Width="28" Height="28" Padding="4" HorizontalContentAlignment="Center" HorizontalAlignment="Center" VerticalAlignment="Center" Command="{Binding CopyCommand}" ToolTip.Tip="Copy"/>
					<Button Content="ðŸ“¦" Width="28" Height="28" Padding="4" HorizontalContentAlignment="Center" HorizontalAlignment="Center" VerticalAlignment="Center" Command="{Binding ToggleArchiveCommand}" ToolTip.Tip="Archive"/>
					<Button Content="ðŸ—‘ï¸" Width="28" Height="28" Padding="4" HorizontalContentAlignment="Center" HorizontalAlignment="Center" VerticalAlignment="Center" Command="{Binding DeleteCommand}" ToolTip.Tip="Delete"/>
				</StackPanel>

				<!-- Edit toolbar -->
				<StackPanel
					IsVisible="{Binding IsEditing}"
					Orientation="Horizontal"
					HorizontalAlignment="Right"
					Spacing="6"
					Margin="0,8,0,0">

					<Button Content="ðŸ’¾" Width="28" Height="28" Padding="4" HorizontalContentAlignment="Center" HorizontalAlignment="Center" VerticalAlignment="Center" Command="{Binding SaveEditCommand}" ToolTip.Tip="Save"/>
					<Button Content="âŒ" Width="28" Height="28" Padding="4" HorizontalContentAlignment="Center" HorizontalAlignment="Center" VerticalAlignment="Center" Command="{Binding CancelEditCommand}" ToolTip.Tip="Cancel"/>
				</StackPanel>

            </StackPanel>

        </DockPanel>
    </Border>
</UserControl>
